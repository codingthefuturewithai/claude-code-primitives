# Implementation Plan: KB-20

**Update knowledge-management skill and setup-collections command for routing hints architecture**

---

## ‚ö†Ô∏è MANDATORY IMPLEMENTATION RULES - READ FIRST

**PAUSE AFTER EVERY COMMIT:**
- This plan contains 3 commits = 3 mandatory pause points
- After EACH commit: generate summary, STOP, wait for user approval
- Do NOT proceed to next unit without explicit "continue" response
- If --auto flag: skip pauses and run all units continuously

**Progress Tracking:**
- Current format: "Unit X of 3"
- Each unit = exactly one commit
- After each unit: STOP and wait for approval (unless --auto)

**Non-Negotiable:**
- 3 commits in this plan = 3 pauses during implementation
- Read the Incremental Implementation Schedule below for explicit pause points

---

## Issue Summary

| Field | Value |
|-------|-------|
| **Key** | KB-20 |
| **Type** | Executable Spec |
| **Summary** | Update knowledge-management skill and setup-collections command for routing hints architecture |
| **Priority** | High |
| **Status** | To Do |
| **Sprint** | KB Sprint 1: Slack and audit |
| **Labels** | rag-memory, routing, skill |

**Key Requirement:** Leverage the new routing hints architecture (routing.examples and routing.exclusions) introduced in KB-19 for smarter content routing.

**Routing Philosophy:**
1. Agent-preferences (user decisions) always override collection routing hints
2. Routing hints are illustrative examples, not exhaustive rules
3. Avoid over-routing to inbox-unsorted - use exclusions as negative scoring signals, not hard filters

---

## Acceptance Criteria

### AC1: setup-collections.md adds routing hints to scaffold collections
- After each `create_collection()` call, add corresponding `update_collection_metadata_schema()` call
- Each of the 5-6 scaffold collections should have 3-5 `routing.examples` and 2-3 `routing.exclusions`
- Do NOT create or mention `agent-preferences` collection (it's auto-created by MCP server)
- Add a note explaining that `agent-preferences` is auto-created

### AC2: knowledge-management SKILL.md uses routing hints for collection selection
- Step R2: Change from `get_collection_info()` to `get_collection_metadata_schema()`
- Step R6: Update collection selection logic to:
  - First check `agent-preferences` for user override preferences (these take priority)
  - Score collections using `routing.examples` and `routing.exclusions` as guidance (not hard rules)
  - Present top 2-3 collections with reasoning showing which example matched
- Clarify that routing hints inform the _type_ of content, not literal matching

### AC3: references/rag-memory.md documents the new MCP tool
- Add documentation for `get_collection_metadata_schema(collection_name)`
- Document parameters and return structure
- Explain when to use it (collection selection for routing)

### AC4: references/preferences.md explains routing hierarchy
- Document the priority order: agent-preferences > collection routing hints
- Explain that routing hints are illustrative, not exhaustive
- Update guidance on when to save preferences (when user overrides AI suggestion)

---

## Codebase Analysis

| Pattern | Finding |
|---------|---------|
| Skill structure | `SKILL.md` with step labels (R1, R2, C1, etc.) and reference docs in `references/` |
| MCP tool pattern | `mcp__rag-memory__<tool_name>()` format |
| Collection naming | kebab-case: `knowledge-and-reference`, `practices-and-procedures` |
| Duplicate files | `commands/rag-memory/setup-collections.md` and `plugins/primitives-toolkit/commands/rag-memory/setup-collections.md` are identical - both need updating |
| Hook integration | `update_collection_metadata` is already in the hook matcher pattern |
| Agent-preferences | Currently has a separate create command, but issue says MCP server auto-creates it now |

**Files to Modify:**
1. `/Users/timkitchens/projects/ai-projects/claude-code-primitives/commands/rag-memory/setup-collections.md`
2. `/Users/timkitchens/projects/ai-projects/claude-code-primitives/plugins/primitives-toolkit/commands/rag-memory/setup-collections.md`
3. `/Users/timkitchens/projects/ai-projects/claude-code-primitives/skills/knowledge-management/SKILL.md`
4. `/Users/timkitchens/projects/ai-projects/claude-code-primitives/skills/knowledge-management/references/rag-memory.md`
5. `/Users/timkitchens/projects/ai-projects/claude-code-primitives/skills/knowledge-management/references/preferences.md`

---

## Implementation Plan

### Unit 1: setup-collections.md (both locations)

**Changes:**
- After each `create_collection()` call, add `update_collection_metadata_schema()` with routing hints
- Add note that `agent-preferences` is auto-created by MCP server
- Remove any reference to manually creating `agent-preferences`

**Routing hints from issue:**

| Collection | routing.examples | routing.exclusions |
|------------|------------------|-------------------|
| knowledge-and-reference | "What does the React docs say about X?", "Official guidelines for Y", "Framework documentation for Z" | "Our team's process for X", "Project notes about Y" |
| projects | "Notes about the redesign project", "What are we building for feature X?", "Project plan for Y" | "External library documentation", "Standard operating procedures" |
| practices-and-procedures | "What is our code review process?", "How do we deploy to production?", "Team workflow for X" | "External documentation", "One-off project plans" |
| people-and-relationships | "What do I know about John?", "Client X's preferences", "Who is the contact for Y?" | "Technical documentation", "Project execution details" |
| inbox-unsorted | "Save this but not sure where it goes", "Quick capture for later sorting" | "Content that clearly fits another collection" |
| business-operations | "Q4 financial records", "Vendor contract details", "Client invoice for X" | "External technical docs", "Personal relationship notes" |

**MCP tool call pattern:**
```python
mcp__rag-memory__update_collection_metadata_schema(
    collection_name="knowledge-and-reference",
    schema={
        "routing": {
            "examples": ["What does the X docs say about Y?", "Official guidelines for Z", "Framework documentation"],
            "exclusions": ["Our team's internal process", "Work-in-progress project notes"]
        }
    }
)
```

### Unit 2: SKILL.md updates

**Changes:**
- Change step R2 from `get_collection_info()` to `get_collection_metadata_schema()`
- Store `routing.examples` and `routing.exclusions` alongside `domain` and `domain_scope`
- Update R6 logic with new collection selection approach:
  1. Check agent-preferences first for explicit user routing preferences
  2. Score remaining collections using routing hints as guidance
  3. Present top 2-3 with reasoning showing matched example type

**Updated R6 logic pattern:**
```
R6. Select collection using routing hints:

1. Check agent-preferences first for explicit user routing preferences
   - If found, use that collection (user decisions override)

2. Score remaining collections:
   - Use routing.examples to understand what TYPE of content fits
   - Use routing.exclusions as negative signals (not hard filters)
   - These are illustrative - match the character, not literal text

3. Present top 2-3 with reasoning:
   "Based on the content, I recommend:
   1. [collection] - similar to: '[matched example type]'
   2. [collection] - similar to: '[matched example type]'"

4. Let user confirm or correct
```

### Unit 3: Reference documentation updates

**references/rag-memory.md:**
- Add new section for `get_collection_metadata_schema(collection_name)`
- Document parameters (collection_name: string, required)
- Document return structure including `metadata_schema.routing.examples` and `metadata_schema.routing.exclusions`
- Explain when to use (collection selection for routing)

**references/preferences.md:**
- Add section on routing hierarchy: agent-preferences > collection routing hints
- Explain routing hints are illustrative examples, not exhaustive rules
- Add guidance: save preferences when user overrides AI suggestion

---

## Testing Strategy

No automated tests in this repo (it's a skills/commands repository).

**Manual Testing (per issue requirements):**

1. **setup-collections test:**
   - Run the command on an empty RAG Memory instance
   - Verify each collection has populated `routing.examples` and `routing.exclusions` via `get_collection_metadata_schema()`

2. **knowledge-management test:**
   - Test routing workflow with content that matches different collection types
   - Verify the skill uses routing hints in its reasoning
   - Check that reasoning shows "similar to: '[example]'" format

3. **agent-preferences auto-creation:**
   - Verify agent-preferences is NOT created by setup-collections
   - Confirm it already exists from MCP server auto-creation

4. **Override behavior:**
   - If user has a preference in agent-preferences, verify that takes priority over collection routing hints

---

## Documentation Updates

All changes in this issue ARE documentation (skill and command definitions). No separate README updates needed.

---

## Commit Strategy

1. `feat: Add routing hints to setup-collections command - refs KB-20`
   - Both setup-collections.md files updated with routing hints
   - Note about agent-preferences auto-creation added

2. `feat: Update knowledge-management skill to use routing hints - refs KB-20`
   - SKILL.md R2 and R6 logic updated
   - New collection selection approach with routing hints

3. `docs: Document get_collection_metadata_schema and routing hierarchy - refs KB-20`
   - references/rag-memory.md updated with new tool docs
   - references/preferences.md updated with routing hierarchy

---

## üîÑ Incremental Implementation Schedule

**CRITICAL: Each unit below = ONE mandatory pause point for user review**

**Total Pause Points:** 3

---

### Unit 1 of 3: Add routing hints to setup-collections command

**Changes:**
- Update `/commands/rag-memory/setup-collections.md` with routing hints after each `create_collection()` call
- Update `/plugins/primitives-toolkit/commands/rag-memory/setup-collections.md` (identical changes)
- Add `update_collection_metadata_schema()` calls for all 6 scaffold collections
- Add note that `agent-preferences` is auto-created by MCP server on startup

**Commit message:**
```
feat: Add routing hints to setup-collections command

- Add update_collection_metadata_schema() calls after each create_collection()
- Each collection now has routing.examples and routing.exclusions
- Add note that agent-preferences is auto-created by MCP server
- Routing hints help AI understand content character for each collection

refs KB-20

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```

‚è∏Ô∏è üõë **PAUSE POINT #1 - STOP AND WAIT FOR USER APPROVAL**

After committing this unit:
1. Generate unit summary showing what changed
2. Display "What would you like to do?" prompt with options: continue/review/revise/stop
3. STOP and WAIT for user response
4. Only proceed to Unit 2 after explicit approval

---

### Unit 2 of 3: Update knowledge-management skill to use routing hints

**Changes:**
- Update SKILL.md step R2: change from `get_collection_info()` to `get_collection_metadata_schema()`
- Update SKILL.md step R6: implement new collection selection logic
  - Check agent-preferences first (user override priority)
  - Score collections using routing.examples and routing.exclusions
  - Present top 2-3 with reasoning showing matched example type
- Update step labels and flow as needed

**Commit message:**
```
feat: Update knowledge-management skill to use routing hints

- R2: Use get_collection_metadata_schema() to retrieve routing hints
- R6: Check agent-preferences first (user decisions override)
- R6: Score collections using routing.examples/exclusions as guidance
- R6: Present recommendations with "similar to: '[example]'" reasoning

refs KB-20

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```

‚è∏Ô∏è üõë **PAUSE POINT #2 - STOP AND WAIT FOR USER APPROVAL**

After committing this unit:
1. Generate unit summary showing what changed
2. Display "What would you like to do?" prompt with options: continue/review/revise/stop
3. STOP and WAIT for user response
4. Only proceed to Unit 3 after explicit approval

---

### Unit 3 of 3: Document get_collection_metadata_schema and routing hierarchy

**Changes:**
- Update `references/rag-memory.md`:
  - Add new section for `get_collection_metadata_schema(collection_name)`
  - Document parameters and return structure
  - Explain when to use for collection selection
- Update `references/preferences.md`:
  - Add routing hierarchy section (agent-preferences > routing hints)
  - Explain routing hints are illustrative, not exhaustive
  - Update when to save preferences guidance

**Commit message:**
```
docs: Document get_collection_metadata_schema and routing hierarchy

- Add get_collection_metadata_schema() to rag-memory.md reference
- Document routing.examples and routing.exclusions return structure
- Add routing hierarchy to preferences.md (agent-preferences takes priority)
- Explain routing hints are illustrative examples, not exhaustive rules

refs KB-20

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```

‚è∏Ô∏è üõë **PAUSE POINT #3 - FINAL UNIT - STOP AND WAIT FOR USER APPROVAL**

After committing this unit:
1. Generate unit summary showing what changed
2. Display "What would you like to do?" prompt
3. STOP and WAIT for user response
4. After approval: Proceed to Implementation Summary

---
